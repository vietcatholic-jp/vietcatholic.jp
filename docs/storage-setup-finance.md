# Finance Storage Bucket Setup Guide

This document outlines the steps to set up the finance storage bucket in Supabase for the finance management system.

## 1. Create Finance Storage Bucket

### Via Supabase Dashboard:
1. Go to your Supabase project dashboard
2. Navigate to Storage section
3. Click "New bucket"
4. Configure the bucket:
   - **Bucket ID**: `finance`
   - **Bucket name**: `finance`
   - **Public**: `false` (private bucket)
   - **File size limit**: `52428800` (50MB)
   - **Allowed MIME types**: `image/*, application/pdf, text/*`

### Via SQL (Alternative):
```sql
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES ('finance', 'finance', false, 52428800, 
        '{"image/*", "application/pdf", "text/*"}'
);
```

## 2. Set Up Storage Policies

### Policy 1: Allow users to upload own files
```sql
CREATE POLICY "Users can upload own files" 
ON storage.objects FOR INSERT 
TO authenticated 
WITH CHECK (
  bucket_id = 'finance' AND 
  (storage.foldername(name))[1] = 'receipts' AND
  auth.uid()::text = (storage.foldername(name))[3]
);
```

### Policy 2: Allow users to view own files
```sql
CREATE POLICY "Users can view own files" 
ON storage.objects FOR SELECT 
TO authenticated 
USING (
  bucket_id = 'finance' AND (
    -- Users can see their own files
    auth.uid()::text = (storage.foldername(name))[3] OR
    -- Cashiers and admins can see all files
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE id = auth.uid() 
      AND role IN ('cashier_role', 'super_admin', 'regional_admin')
    )
  )
);
```

### Policy 3: Allow users to delete own files
```sql
CREATE POLICY "Users can delete own files" 
ON storage.objects FOR DELETE 
TO authenticated 
USING (
  bucket_id = 'finance' AND (
    -- Users can delete their own files
    auth.uid()::text = (storage.foldername(name))[3] OR
    -- Admins can delete any file
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE id = auth.uid() 
      AND role IN ('super_admin', 'regional_admin')
    )
  )
);
```

### Policy 4: Allow event organizers to upload expense attachments
```sql
CREATE POLICY "Event organizers can upload expense attachments" 
ON storage.objects FOR INSERT 
TO authenticated 
WITH CHECK (
  bucket_id = 'finance' AND 
  (storage.foldername(name))[1] = 'expenses' AND
  EXISTS (
    SELECT 1 FROM public.users 
    WHERE id = auth.uid() 
    AND role IN ('event_organizer', 'super_admin', 'regional_admin')
  )
);
```

### Policy 5: Allow cashiers to upload transfer receipts
```sql
CREATE POLICY "Cashiers can upload transfer receipts" 
ON storage.objects FOR INSERT 
TO authenticated 
WITH CHECK (
  bucket_id = 'finance' AND 
  (storage.foldername(name))[1] = 'transfers' AND
  EXISTS (
    SELECT 1 FROM public.users 
    WHERE id = auth.uid() 
    AND role IN ('cashier_role', 'super_admin')
  )
);
```

## 3. Directory Structure

The finance bucket follows this structure:
```
finance/
├── receipts/
│   └── {eventId}/
│       └── {registrationId}/
│           └── {filename}
├── expenses/
│   └── {eventId}/
│       └── {expenseId}/
│           └── attachments/
│               └── {filename}
└── transfers/
    └── {eventId}/
        └── {expenseId}/
            └── {filename}
```

## 4. API Integration

The storage bucket works with signed URLs generated by the API endpoints:

### For receipts:
- Upload: `POST /api/receipts/upload`
- Download: `GET /api/receipts/{receiptId}/download`

### For expense attachments:
- Upload: `POST /api/expenses/{expenseId}/attachments`
- Download: `GET /api/expenses/{expenseId}/attachments/{attachmentId}`

### For transfer receipts:
- Upload: `POST /api/admin/expenses/{expenseId}/transfer` (includes file upload)

## 5. Security Notes

- All files in the finance bucket are private by default
- Access is controlled through RLS policies that check user roles
- Files are served via signed URLs generated by API endpoints
- Event scoping ensures users can only access files from events they have permission for
- Cashiers have read access to all finance files within their authorized events
- Super admins have full access to all finance files

## 6. File Size and Type Limits

- Maximum file size: 50MB
- Allowed file types:
  - Images: All image formats (receipts, photos of documents)
  - PDFs: For invoices and formal documents
  - Text files: For additional documentation

## 7. Cleanup and Maintenance

Consider implementing:
- Automated cleanup of old files after events are completed
- File compression for large images
- Archive policies for closed expense requests
- Regular backup of important financial documents

This storage setup ensures secure, role-based access to financial documents while maintaining event-level scoping as required by the finance management plan.